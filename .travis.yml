language: go

go:
  - "1.10.x"
  - master
  
os:
  - linux
  #- osx !temporal
  - windows

sudo: false

notifications:
  slack: 
    secure: "jpatUgLOzhgwM9bmVDErYloqwIKmEo4Ifr5an3Btyel6/g6zi/f/tQloaGICl2d4VlJiUNQWOHlFg/iM3QrzYb4vfbRrzofq15CC+QdxzzXcWtmGScCtmfq6v/USsRKpdoetW7qm85bBLa5NZs2C2IqaRB5TGZ2jDzf6P45r2hW1rpgnOLC1R/8lGQ49a5oVb9pdWMEIFxSUei+sBw0NlJLXexJxssfopYILQNUQGBBucGP8sCQlWSOR5acR+/WL/PdkTeYEssLdJ5rdbiYW8zAkXLJ+IjdknDjX0WELiM7UQr5rb0bxZKjQca3LHL4YjQ97nyVzIXfWZYbkpk5UXdJkQtXxDaQJ78Pe/a7TIrL44/cTRhCFHqOu7PsY1xjw6eiFPpMAURRgIx5xCr9ctKAgbo3+v+pIj/84xWtQfhgaNklvj5hmFkbpJG55VqWwJZXijqFVHfoEVNzkN0s2NZZ4AexNpX0LEtPKWy0/cZtnDeI9NgtvlY3nqYOIL6mICVI/PMruzDrOZvt/Qm9Fw0YbBLRuchwWZl8AgWFw4g7Q/q5WHft08E2NjitL4tB0efxXDLRXJGmXvBCqE3txYhFIbU/ZEHKau6mxBiTiNOXmtz804wRniNo+6FqBdsHJcVOKbxWX2/lhy20tMlXRVXpqN2/y50xFaPxqu1fT3uE="

branches:
  only:
    - master
    
services:
  - memcache 
  - redis-server
  - postgresql
  
before_install:
  - ln -s $GOPATH/src/github.com/pdmp/amai $GOPATH/src/amai
  - echo $TRAVIS_OS_NAME
  - |
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew update && brew install memcached redis && brew services start redis && brew services start memcached
      export PG_DATA=$(brew --prefix)/var/postgres
      pg_ctl -w start -l postgres.log --pgdata ${PG_DATA}
      createuser -s postgres
      psql -c 'create database amai_development;' -U postgres
      cat postgres.log
    fi
  - redis-server --daemonize yes
  - redis-cli info
  - |
    if [[ "$TRAVIS_OS_NAME" != "osx" ]]; then
      psql -c 'create database amai_development;' -U postgres
    fi 
  
  
install:
  - export PATH=$PATH:$HOME/gopath/bin
  - export REVEL_BRANCH="develop"
  - 'if [[ "$TRAVIS_BRANCH" == "master" ]]; then export REVEL_BRANCH="master"; fi'
  - 'echo "Travis branch: $TRAVIS_BRANCH, Revel dependency branch: $REVEL_BRANCH"'
  - git clone -b $REVEL_BRANCH git://github.com/revel/modules ../modules/
  - git clone -b $REVEL_BRANCH git://github.com/revel/cmd ../cmd/
  - git clone -b $REVEL_BRANCH git://github.com/revel/config ../config/
  - git clone -b $REVEL_BRANCH git://github.com/revel/cron ../cron/
  - git clone -b $REVEL_BRANCH git://github.com/revel/examples ../examples/
  - go get -v github.com/revel/revel/...
  - go get -v github.com/revel/cmd/revel
  - go get -v github.com/mattn/go-sqlite3
  - go get -v github.com/jinzhu/gorm
  
script:
  - revel test    github.com/pdmp/amai dev


matrix:
  allow_failures:
    os: osx
